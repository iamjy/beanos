/**
* @file
* @author
* @date
* @brief
* @see
*/

/*****************************************************************************
 * Headers
 *****************************************************************************/
#include "stdint.h"
#include "stdbool.h"
#include "stddef.h"
#include "stdlib.h"
#include "armv7ar.h"
#include "synch.h"


/*****************************************************************************
 * Macro definitions
 *****************************************************************************/
/*****************************************************************************
 * Type definitions
 *****************************************************************************/
/*****************************************************************************
 * Enumerations
 *****************************************************************************/
/*****************************************************************************
 * Static variables
 *****************************************************************************/
/* ---------------------------------------------------------------------------
 * Semaphore
 --------------------------------------------------------------------------- */
static int32_t s_sem_max;
static int32_t s_sem;

/* ---------------------------------------------------------------------------
 * Mutex
 --------------------------------------------------------------------------- */
static kernel_mutex_t s_mutex;


/*****************************************************************************
 * Extern variables
 *****************************************************************************/
/* ---------------------------------------------------------------------------
   - Variable
 --------------------------------------------------------------------------- */
/* ---------------------------------------------------------------------------
   - Function
 --------------------------------------------------------------------------- */
/*****************************************************************************
 * Global variables
 *****************************************************************************/
/*****************************************************************************
 * Function prototypes
 *****************************************************************************/
void kernel_sem_init( int32_t max )
{
    s_sem_max = ( max <= 0 ) ? DEF_SEM_MAX : max;
    s_sem_max = ( max >= DEF_SEM_MAX ) ? DEF_SEM_MAX : max;

    s_sem = s_sem_max;
}

bool kernel_sem_lock( void )
{
    if ( s_sem <= 0 )
        return false;

    s_sem--;

    return true;
}

void kernel_sem_unlock( void )
{
    s_sem++;

    if ( s_sem >= s_sem_max )
        s_sem = s_sem_max;
}

void kernel_mutex_init( void )
{
    s_mutex.owner = 0;
    s_mutex.lock  = false;
}

bool kernel_mutex_lock( uint32_t owner )
{
    if ( s_mutex.lock )
        return false;

    s_mutex.owner = owner;
    s_mutex.lock  = true;

    return true;
}

bool kernel_mutex_unlock( uint32_t owner )
{
    if ( owner == s_mutex.owner ) {
        s_mutex.lock = false;

        return true;
    }

    return false;
}

