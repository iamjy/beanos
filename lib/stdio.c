/**
* @file
* @author
* @date
* @brief
* @see
*/

/*****************************************************************************
 * Header files
 *****************************************************************************/
#include "stdint.h"
#include "stdarg.h"
#include "stdio.h"
#include "hal_uart.h"


/*****************************************************************************
 * Macro definitions
 *****************************************************************************/
#define PRINTF_BUF_LEN    1024


/*****************************************************************************
 * Type definitions
 *****************************************************************************/
/* ---------------------------------------------------------------------------
   - 
 --------------------------------------------------------------------------- */
/*****************************************************************************
 * Enumerations
 *****************************************************************************/
/* ---------------------------------------------------------------------------
   - 
 --------------------------------------------------------------------------- */
/*****************************************************************************
 * Static variables
 *****************************************************************************/
/* ---------------------------------------------------------------------------
   - Variable
 --------------------------------------------------------------------------- */
static char s_printf_buf[PRINTF_BUF_LEN];   //< 1KiB (1024byte)


/*****************************************************************************
 * Extern variables
 *****************************************************************************/
/* ---------------------------------------------------------------------------
   - 
 --------------------------------------------------------------------------- */
/*****************************************************************************
 * Global variables
 *****************************************************************************/
/*****************************************************************************
 * Function definitions
 *****************************************************************************/
uint32_t putstr( const char *str )
{
    uint32_t c = 0;

    while ( *str ) {
        HAL_uart_put_char(*str++);
        c++;
    }

    return c;
}

uint32_t debug_printf( const char *fmt, ... )
{
    va_list args;
    va_start( args, fmt );
    vsprintf( s_printf_buf, fmt, args );
    va_end( args );

    return putstr( s_printf_buf );
}

uint32_t vsprintf( char *buf, const char *fmt, va_list ap )
{
    uint32_t c = 0;
    char ch = '\0';
    char *str = NULL;
    uint32_t uint = 0;
    uint32_t hex = 0x0;
    uint32_t i = 0, j = 0;

    for ( i = 0; fmt[i]; i++ ) {
        if ( fmt[i] == '%' ) {

            i++;

            switch ( fmt[i] ) {
            case 'c':
                ch = ( char )va_arg( ap, int32_t );
                buf[j++] = ch;
                break;
            case 's':
                str = ( char * )va_arg( ap, char * );
                if ( str == NULL )
                    str = "(null)";

                while ( *str )
                    buf[j++] = *( str++ );

                break;
            case 'u':
                uint = ( uint32_t )va_arg( ap, uint32_t );
                j += utoa( &buf[j], uint, utoa_dec );
                break;
            case 'x':
                hex = ( uint32_t )va_arg( ap, uint32_t );
                j += utoa( &buf[j], hex, utoa_hex );
                break;
            default:
                break;
            }
        }
        else {
            buf[j++] = fmt[i];
        }
    }

    if ( j >= 256 ) {
        buf[0] = '\0';
        return 0;
    }

    buf[j] = '\0';
    return j;
}

uint32_t utoa( char* buf, uint32_t val, utoa_t base )
{
    uint32_t c = 0;
    int32_t  i = 0;
    char tmp[11];   //< It is big enough for store 32 bit int

    do {
        uint32_t t = val % ( uint32_t )base;

        if ( t >= 10 )
            t += 'A' - '0' - 10;

        tmp[i] = ( t + '0' );
        val /= base;

        i++;
    } while ( val );

    i--;  //< Reverse
    while ( i >= 0 ) {
        buf[c++] = tmp[i];
        
        i--;
    }

    return c;
}